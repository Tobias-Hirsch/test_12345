version: "3.9"

services:
  # --- Database & Infrastructure Services ---
  milvus:
    user: root
    image: milvusdb/milvus:latest
    ports:
      - "19530:19530"
      - "9091:9091"
    volumes:
      - milvus_data:/var/lib/milvus/data
      - milvus_logs:/var/lib/milvus/logs
      - milvus_config:/var/lib/milvus/config
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ENDPOINT: minio:9000
      MINIO_BUCKET_NAME: mm-rag-bucket
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    networks:
      - rosti-net2
    depends_on:
      - etcd
      - minio

  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    ports:
      - "2379:2379"
    environment:
      ALLOW_NONE_AUTHENTICATION: "yes"
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd:2379
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
    networks:
      - rosti-net2

  minio:
    image: minio/minio:RELEASE.2025-04-08T15-41-24Z
    ports:
      - "9100:9000"
      - "9101:9001"
    volumes:
      - minio_data:/data
    environment:
      MINIO_ROOT_USER: "minioadmin"
      MINIO_ROOT_PASSWORD: "minioadmin"
    command: ["server", "/data", "--console-address", ":9001"]
    networks:
      - rosti-net2

  mysql:
    image: mysql:8.0
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: rag_db
      MYSQL_USER: app
      MYSQL_PASSWORD: app_password123
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - rosti-net2

  redis:
    image: redis:7.0
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - rosti-net2

  mongodb:
    image: mongo:latest
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: password
    networks:
      - rosti-net2

  # --- Application Services ---
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    env_file:
      - .env.prod
    deploy:
      resources:
        limits:
          memory: 16G
        reservations:
          memory: 8G
    ports:
      - "8001:8000"
    environment:
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_DB: rag_db
      MYSQL_USER: app
      MYSQL_PASSWORD: app_password123
      MILVUS_HOST: milvus
      MILVUS_PORT: 19530
      MONGO_URI: mongodb://root:password@mongodb:27017
      MONGO_DB_NAME: rag_db
      REDIS_HOST: redis
      REDIS_PORT: 6379
      FRONTEND_BASE_URL: http://141.3.142.150:8080
      MODELSCOPE_CACHE: /modelscope_cache
      HUGGINGFACE_HUB_CACHE: /huggingface_cache
      HF_HUB_OFFLINE: "1"
      MINIO_ENDPOINT: minio:9000
      MINIO_BUCKET_NAME: mm-rag-bucket
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    volumes:
      - backend_logs:/app/logs      
      - ./backend/alembic:/app/alembic
      - ./verify_milvus.py:/app/verify_milvus.py:ro
      - ./cleanup_milvus.py:/app/cleanup_milvus.py:ro
      - ./cleanup_mongodb.py:/app/cleanup_mongodb.py:ro
      - ./diagnose_rag.py:/app/diagnose_rag.py:ro
      - ./backend/migrate_policies.py:/app/migrate_policies.py:ro
      - ./diagnose_data_inconsistency.py:/app/diagnose_data_inconsistency.py:ro
      - ./models:/app/models
      - /home/cjb/.cache/modelscope/hub:/modelscope_cache
      - /home/cjb/.cache/huggingface/hub:/huggingface_cache
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - rosti-net2
    depends_on:
      - milvus
      - mysql
      - redis
      - mongodb

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    env_file:
      - frontend/.env
    networks:
      - rosti-net2
    # Gateway routet auf frontend:80 innerhalb des Netzes.

  docs:
    build:
      context: ./docs
      dockerfile: Dockerfile
    container_name: rosti_docs
    restart: unless-stopped
    networks:
      - rosti-net2

  gateway:
    image: nginx:stable-alpine
    ports:
      - "8080:80"
    volumes:
      - ./Docker/nginx:/etc/nginx/conf.d:ro 
    networks:
      - rosti-net2
    depends_on:
      - backend
      - frontend
      - docs

  paddleocr:
    # Optional: eigenes Image statt Build, aktuell Build:
    build:
      context: ./Docker/paddleocr
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      - ENABLE_PREPROCESSING=true
      - PREPROCESS_BLUR_KERNEL=5
      - PREPROCESS_ADAPTIVE_BLOCK=11
      - PREPROCESS_ADAPTIVE_C=2
    volumes:
      - ./models/paddlex-models:/root/.paddlex
    networks:
      - rosti-net2
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['1']   # GPU 1
              capabilities: ["gpu"]

  latexocr:
    image: lukasblecher/pix2tex:api
    container_name: latexocr
    restart: unless-stopped
    environment:
      DEVICE: cuda
    ports:
      - "8002:8002"
    volumes:
      - ./models/latexocr-model/weights.pth:/opt/conda/lib/python3.10/site-packages/pix2tex/model/checkpoints/weights.pth:ro
    networks:
      - rosti-net2
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['1']   # GPU 1
              capabilities: ["gpu"]

  ollama-serving:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    networks:
      - rosti-net2
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
      - /home/cjb/.ollama:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']   # GPU 0
              capabilities: ["gpu"]

  ollama-embedding:
    image: ollama/ollama:latest
    ports:
      - "11435:11434"
    volumes:
      - ollama_data:/root/.ollama
      - /home/cjb/.ollama:/root/.ollama
    networks:
      - rosti-net2
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['1']   # GPU 1
              capabilities: ["gpu"]

  mineru-sglang-server:
    image: alexsuntop/mineru-sglang:latest
    ports:
      - "30001:30000"
    environment:
      MINERU_MODEL_SOURCE: local
      # optional zur Sicherheit:
      CUDA_VISIBLE_DEVICES: ""   # verhindert versehentlichen GPU-Zugriff
    entrypoint: mineru-sglang-server
    command:
      - --host
      - 0.0.0.0
      - --port
      - "30000"
      - --device
      - cpu
      - --mem-fraction-static
      - "0.5"
    shm_size: "32g"
    ipc: host
    ulimits:
      memlock: -1
      stack: 67108864
    networks:
      - rosti-net2
    restart: unless-stopped


# --- Network Definition ---
networks:
  rosti-net2:
    driver: bridge
    external: false

# --- Volumes ---
volumes:
  milvus_data:
  milvus_logs:
  milvus_config:
  minio_data:
  mysql_data:
  redis_data:
  mongodb_data:
  ollama_data:
  backend_logs:
